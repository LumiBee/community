version: '3.8'

services:
  # 1. MySQL æ•°æ®åº“æœåŠ¡
  mysql-db:
    image: mysql:8.0
    container_name: mysql-db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD}
      MYSQL_DATABASE: community
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql # å°†æ•°æ®æŒä¹…åŒ–åˆ° volume
    networks:
      - hive-net
    healthcheck:
      test: ["CMD-SHELL", "mysql -h localhost -u root -p${DB_PASSWORD} -e 'SELECT 1'"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  # 2. Redis ç¼“å­˜æœåŠ¡
  redis-cache:
    image: redis:6.2-alpine
    container_name: redis-cache
    restart: always
    command: redis-server --appendonly yes # å¯ç”¨æŒä¹…åŒ–
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - hive-net

  # 3. Elasticsearch æœç´¢æœåŠ¡ (å¸¦ IK æ’ä»¶)
  elasticsearch-search:
    build: ./elasticsearch # ä½¿ç”¨æˆ‘ä»¬ç¬¬äºŒæ­¥åˆ›å»ºçš„ Dockerfile æ¥æ„å»º
    container_name: elasticsearch-search
    restart: always
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false # å¼€å‘ç¯å¢ƒç¦ç”¨å®‰å…¨ç‰¹æ€§ï¼Œç®€åŒ–é…ç½®
      - "ES_JAVA_OPTS=-Xms256m -Xmx256m" # è®¾ç½®JVMå†…å­˜
    ports:
      - "9200:9200"
      - "9300:9300"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - hive-net

  # 4. Spring Boot åº”ç”¨æœåŠ¡
  hive-app:
    build: . # ä½¿ç”¨ç¬¬ä¸€æ­¥åˆ›å»ºçš„ Dockerfile æ¥æ„å»º
    container_name: hive-app
    restart: always
    depends_on: # ç¡®ä¿åœ¨ä¾èµ–æœåŠ¡å¯åŠ¨åå†å¯åŠ¨
      mysql-db:
        condition: service_healthy
      redis-cache:
          condition: service_started
      elasticsearch-search:
          condition: service_started
    ports:
      - "8090:8090"
    env_file:
      - .env # åŠ è½½ç¯å¢ƒå˜é‡æ–‡ä»¶
    å¥½çš„ï¼Œæ„Ÿè°¢æä¾›é…ç½®æ–‡ä»¶ï¼Œé—®é¢˜å·²ç»éå¸¸æ¸…æ¥šäº†ã€‚

    ä½ çš„ docker-compose.yml é…ç½®å¾—éå¸¸è§„èŒƒï¼Œé—®é¢˜å‡ºåœ¨ Spring Boot çš„é…ç½®æ–‡ä»¶ application.yml ä¸Šã€‚

    é—®é¢˜æ ¹æº ğŸ¯
    Docker ç½‘ç»œ: åœ¨ä½ çš„ docker-compose.yml ä¸­ï¼Œä½ åˆ›å»ºäº†ä¸€ä¸ªåä¸º hive-net çš„ç½‘ç»œï¼Œå¹¶ä¸”æ‰€æœ‰æœåŠ¡ï¼ˆhive-app, mysql-db, redis-cache, elasticsearch-searchï¼‰éƒ½è¿æ¥åˆ°äº†è¿™ä¸ªç½‘ç»œã€‚è¿™ä½¿å¾—å®ƒä»¬å¯ä»¥é€šè¿‡æœåŠ¡åï¼ˆä¾‹å¦‚ mysql-dbï¼‰ç›¸äº’é€šä¿¡ã€‚

    Spring é…ç½®: ä½ çš„ application.ymlï¼ˆé»˜è®¤é…ç½®æ–‡ä»¶ï¼‰ä¸­ï¼Œæ‰€æœ‰æœåŠ¡çš„è¿æ¥åœ°å€éƒ½æŒ‡å‘äº† localhostã€‚

    æ•°æ®åº“ URL: jdbc:mysql://localhost:3306/community...

    Redis ä¸»æœº:
      host: localhost

    Elasticsearch URI: http://localhost:9200

    æ ¸å¿ƒå†²çª: å½“ hive-app å®¹å™¨å¯åŠ¨æ—¶ï¼Œå®ƒåŠ è½½äº† application.yml çš„é…ç½®ï¼Œå¹¶å°è¯•è¿æ¥åˆ° localhostã€‚åœ¨ Docker å®¹å™¨çš„è¯­å¢ƒé‡Œï¼Œlocalhost æŒ‡çš„æ˜¯å®¹å™¨æœ¬èº«ã€‚å› æ­¤ï¼Œhive-app æ­£åœ¨è‡ªå·±çš„å®¹å™¨å†…éƒ¨å¯»æ‰¾ MySQLã€Redis å’Œ ES æœåŠ¡ï¼Œä½†è¿™äº›æœåŠ¡å®é™…ä¸Šæ˜¯è¿è¡Œåœ¨å…¶ä»–ç‹¬ç«‹å®¹å™¨ä¸­çš„ï¼Œæ‰€ä»¥è‡ªç„¶ä¼šè¿æ¥å¤±è´¥ï¼ŒæŠ›å‡º Connection refused å¼‚å¸¸ã€‚

    è§£å†³æ–¹æ¡ˆ ğŸ› ï¸
    ä½ æœ‰ä¸¤ç§æ–¹æ¡ˆå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ¨èä½¿ç”¨æ–¹æ¡ˆä¸€ï¼Œå› ä¸ºå®ƒæ›´ç¬¦åˆä½ å½“å‰çš„prodç¯å¢ƒé…ç½®ã€‚

    æ–¹æ¡ˆä¸€ (æ¨è): åœ¨ Docker ä¸­æ¿€æ´» prod Profile
    ä½ çš„é¡¹ç›®å·²ç»æœ‰äº† application-prod.yml æ–‡ä»¶ï¼Œå®ƒä½¿ç”¨ç¯å¢ƒå˜é‡æ¥é…ç½®è¿æ¥ï¼Œè¿™æ˜¯åœ¨ Docker ä¸­éƒ¨ç½²çš„æœ€ä½³å®è·µã€‚ä½ åªéœ€è¦åœ¨ docker-compose.yml ä¸­å‘Šè¯‰ Spring Boot æ¿€æ´»è¿™ä¸ª prod é…ç½®å³å¯ã€‚

    1. ä¿®æ”¹ docker-compose.yml

    åœ¨ hive-app æœåŠ¡çš„ environment éƒ¨åˆ†ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼Œè¯·æ·»åŠ è¯¥å­—æ®µï¼‰ï¼Œæ·»åŠ ä¸€ä¸ªç¯å¢ƒå˜é‡æ¥æ¿€æ´» prod profileï¼š

    YAML

    # 4. Spring Boot åº”ç”¨æœåŠ¡
    hive-app:
      build: .
      container_name: hive-app
      restart: always
      depends_on:
        mysql-db:
          condition: service_healthy
        redis-cache:
          condition: service_started
        elasticsearch-search:
          condition: service_started
      ports:
        - "8090:8090"
      env_file:
        - .env
      environment:
        - SPRING_PROFILES_ACTIVE=prod
      networks:
      - hive-net
      command: >
        /bin/sh -c "
          echo '--- Waiting for 20 seconds for services to be fully ready... ---'
          sleep 20
          echo '--- Starting Spring Boot Application with IPv4 preference... ---'
          exec java -Djava.net.preferIPv4Stack=true -jar /app.jar
        "

# å®šä¹‰æ•°æ®å·ï¼Œç”¨äºæŒä¹…åŒ–å­˜å‚¨
volumes:
  mysql-data:
  redis-data:
  es-data:

# å®šä¹‰ç½‘ç»œï¼Œè®©æ‰€æœ‰æœåŠ¡éƒ½åœ¨åŒä¸€ä¸ªç½‘ç»œä¸­ï¼Œå¯ä»¥é€šè¿‡æœåŠ¡åäº’ç›¸è®¿é—®
networks:
  hive-net:
    driver: bridge