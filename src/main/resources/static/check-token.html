<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Token</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <h1>JWT Token Checker</h1>
    
    <div class="card">
        <h2>LocalStorage Token</h2>
        <div id="localStorage-info"></div>
        <pre id="localStorage-content"></pre>
        <button onclick="checkLocalStorage()">Check LocalStorage</button>
    </div>
    
    <div class="card">
        <h2>Test API Request with Token</h2>
        <div id="api-result"></div>
        <pre id="api-response"></pre>
        <button onclick="testApiRequest('/api/portfolios')">Test GET /api/portfolios</button>
        <button onclick="testApiRequest('/api/user/current')">Test GET /api/user/current</button>
    </div>
    
    <div class="card">
        <h2>Login Test</h2>
        <div>
            <label for="account">Account:</label>
            <input type="text" id="account" value="lumibee">
        </div>
        <div style="margin-top: 10px;">
            <label for="password">Password:</label>
            <input type="password" id="password" value="114514">
        </div>
        <div style="margin-top: 10px;">
            <label>
                <input type="checkbox" id="remember-me" checked>
                Remember me
            </label>
        </div>
        <div style="margin-top: 10px;">
            <button onclick="testLogin()">Test Login</button>
        </div>
        <div id="login-result" style="margin-top: 10px;"></div>
        <pre id="login-response"></pre>
    </div>

    <script>
        function checkLocalStorage() {
            const localStorageInfo = document.getElementById('localStorage-info');
            const localStorageContent = document.getElementById('localStorage-content');
            
            const authUserKey = 'hive_auth_user';
            const authUser = localStorage.getItem(authUserKey);
            
            if (authUser) {
                try {
                    const userData = JSON.parse(authUser);
                    localStorageInfo.innerHTML = `<p style="color: green;">✅ Found user data in localStorage with key '${authUserKey}'</p>`;
                    
                    if (userData.token) {
                        localStorageInfo.innerHTML += `<p style="color: green;">✅ Token found in user data</p>`;
                        
                        // Parse JWT token
                        try {
                            const tokenParts = userData.token.split('.');
                            if (tokenParts.length === 3) {
                                const header = JSON.parse(atob(tokenParts[0]));
                                const payload = JSON.parse(atob(tokenParts[1]));
                                
                                localStorageInfo.innerHTML += `<p>Token algorithm: ${header.alg}</p>`;
                                localStorageInfo.innerHTML += `<p>Token type: ${header.typ || 'JWT'}</p>`;
                                localStorageInfo.innerHTML += `<p>User ID: ${payload.sub}</p>`;
                                localStorageInfo.innerHTML += `<p>User name: ${payload.name}</p>`;
                                localStorageInfo.innerHTML += `<p>User email: ${payload.email}</p>`;
                                
                                const issuedAt = new Date(payload.iat * 1000);
                                const expiresAt = new Date(payload.exp * 1000);
                                const now = new Date();
                                
                                localStorageInfo.innerHTML += `<p>Issued at: ${issuedAt.toLocaleString()}</p>`;
                                localStorageInfo.innerHTML += `<p>Expires at: ${expiresAt.toLocaleString()}</p>`;
                                
                                if (now > expiresAt) {
                                    localStorageInfo.innerHTML += `<p style="color: red;">❌ Token is expired</p>`;
                                } else {
                                    const remainingTime = Math.floor((expiresAt - now) / 1000 / 60);
                                    localStorageInfo.innerHTML += `<p style="color: green;">✅ Token is valid (expires in ${remainingTime} minutes)</p>`;
                                }
                            }
                        } catch (e) {
                            localStorageInfo.innerHTML += `<p style="color: orange;">⚠️ Could not parse JWT token: ${e.message}</p>`;
                        }
                    } else {
                        localStorageInfo.innerHTML += `<p style="color: red;">❌ No token found in user data</p>`;
                    }
                    
                    localStorageContent.textContent = JSON.stringify(userData, null, 2);
                } catch (e) {
                    localStorageInfo.innerHTML = `<p style="color: orange;">⚠️ Found data in localStorage but could not parse as JSON: ${e.message}</p>`;
                    localStorageContent.textContent = authUser;
                }
            } else {
                localStorageInfo.innerHTML = `<p style="color: red;">❌ No data found in localStorage with key '${authUserKey}'</p>`;
                localStorageContent.textContent = '';
            }
        }
        
        async function testApiRequest(url) {
            const apiResult = document.getElementById('api-result');
            const apiResponse = document.getElementById('api-response');
            
            apiResult.innerHTML = `<p>Testing API request to ${url}...</p>`;
            
            try {
                // Get token from localStorage
                const authUser = localStorage.getItem('hive_auth_user');
                let token = null;
                
                if (authUser) {
                    try {
                        const userData = JSON.parse(authUser);
                        if (userData.token) {
                            token = userData.token;
                        }
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }
                
                // Make request with token
                const headers = {
                    'Content-Type': 'application/json'
                };
                
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                    apiResult.innerHTML += `<p>Including Authorization header: Bearer ${token.substring(0, 20)}...</p>`;
                } else {
                    apiResult.innerHTML += `<p style="color: orange;">⚠️ No token found, making request without Authorization header</p>`;
                }
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: headers,
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    apiResult.innerHTML += `<p style="color: green;">✅ Request successful (${response.status})</p>`;
                } else {
                    apiResult.innerHTML += `<p style="color: red;">❌ Request failed (${response.status}): ${response.statusText}</p>`;
                }
                
                apiResponse.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                apiResult.innerHTML += `<p style="color: red;">❌ Error: ${error.message}</p>`;
                apiResponse.textContent = error.toString();
            }
        }
        
        async function testLogin() {
            const loginResult = document.getElementById('login-result');
            const loginResponse = document.getElementById('login-response');
            
            const account = document.getElementById('account').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('remember-me').checked;
            
            loginResult.innerHTML = `<p>Testing login with account: ${account}, remember-me: ${rememberMe}...</p>`;
            
            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account: account,
                        password: password,
                        'remember-me': rememberMe ? 'on' : ''
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    loginResult.innerHTML += `<p style="color: green;">✅ Login successful</p>`;
                    
                    // Save user data to localStorage
                    if (data.user) {
                        localStorage.setItem('hive_auth_user', JSON.stringify(data.user));
                        loginResult.innerHTML += `<p style="color: green;">✅ User data saved to localStorage</p>`;
                        
                        if (data.user.token) {
                            loginResult.innerHTML += `<p style="color: green;">✅ Token found in user data</p>`;
                        } else {
                            loginResult.innerHTML += `<p style="color: red;">❌ No token found in user data</p>`;
                        }
                    } else {
                        loginResult.innerHTML += `<p style="color: red;">❌ No user data in response</p>`;
                    }
                    
                    // Set temp_session in sessionStorage if not remember-me
                    if (!rememberMe) {
                        sessionStorage.setItem('temp_session', 'true');
                        loginResult.innerHTML += `<p>Set temp_session in sessionStorage</p>`;
                    } else {
                        sessionStorage.removeItem('temp_session');
                        loginResult.innerHTML += `<p>Removed temp_session from sessionStorage</p>`;
                    }
                } else {
                    loginResult.innerHTML += `<p style="color: red;">❌ Login failed: ${data.message || 'Unknown error'}</p>`;
                }
                
                loginResponse.textContent = JSON.stringify(data, null, 2);
            } catch (error) {
                loginResult.innerHTML += `<p style="color: red;">❌ Error: ${error.message}</p>`;
                loginResponse.textContent = error.toString();
            }
        }
        
        // Check localStorage on page load
        checkLocalStorage();
    </script>
</body>
</html>
