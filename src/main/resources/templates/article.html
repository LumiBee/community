<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
	<th:block th:insert="~{fragments/page-head :: common-head-content}"></th:block>
	<title th:text="${article?.title} ?: 'Lumi Hive'">Lumi Hive</title>
	<meta name="article-id" th:if="${article != null}" th:content="${article.articleId}"/>
	<link href="/css/article.css" rel="stylesheet"/>
	<!-- 添加当前用户ID的meta标签，用于前端检测自关注 -->
	<meta name="current-user-id" th:if="${#authentication != null && #authentication.principal instanceof T(com.lumibee.hive.model.User)}" th:content="${#authentication.principal.id}"/>
</head>
<body>
<!-- 导航栏 -->
<div th:replace="~{fragments/header :: navbar}"></div>

<!-- 文章头部区域 -->
<div class="container-fluid" style="max-width: 1600px;">
	<div class="jumbotron jumbotron-fluid mb-3 pl-0 pt-0 pb-0 bg-white position-relative">
		<div class="h-100 tofront">
			<div class="justify-content-between">
				<div class="pt-5 align-self-center">
					<h1 class="display-4 secondfont mb-3 font-weight-bold" th:text="${article.title}">文章标题</h1>
					<p class="mb-3 lead" th:text="${article.excerpt}" th:if="${article.excerpt}">
						文章摘要内容...
					</p>
					<!-- 文章标签 -->
					<div class="mb-4 w-100" th:if="${article.tags != null and not #lists.isEmpty(article.tags)}">
						<div style="display: flex; align-items: end; width: 100%;">
							<div th:each="tag : ${article.tags}" class="d-inline-block">
								<a th:href="@{'/tags#' + ${tag.name}}"
								   class="badge badge-tag mr-2 mb-2 tag-link"
								   th:text="${tag.name}"
								   th:title="'查看更多 ' + ${tag.name} + ' 相关文章'">
									标签
								</a>
							</div>
						</div>
					</div>
					
					<!-- 作品集信息 -->
					<div class="mb-4" th:if="${article.portfolio != null}">
						<span>作品集：</span>
						<a th:href="@{'/portfolio/' + ${article.portfolio.getSlug()}}" class="portfolio-pill">
							<i class="fas fa-book-open mr-1"></i>
							<span th:text="${article.portfolio.getName()}">作品集名称</span>
						</a>
					</div>

					<div class="d-flex align-items-center">
					<a th:if="${article.userName}" th:href="@{'/profile/' + ${article.userName}}" title="查看作者主页">
						<img th:if="${article.avatarUrl != null and !article.avatarUrl.isEmpty()}"
							 th:src="${article.avatarUrl}"
							 alt="作者头像"
							 class="rounded-circle"
							 style="width: 40px; height: 40px;">
						<img th:unless="${article.avatarUrl != null and !article.avatarUrl.isEmpty()}"
							 src="/img/demo/avatar2.jpg"
							 alt="默认头像"
							 class="rounded-circle"
							 style="width: 40px; height: 40px;">
					</a>
					<th:block th:unless="${article.userName}">
						<img th:if="${article.avatarUrl != null and !article.avatarUrl.isEmpty()}"
							 th:src="${article.avatarUrl}"
							 alt="作者头像"
							 class="rounded-circle"
							 style="width: 40px; height: 40px;">
						<img th:unless="${article.avatarUrl != null and !article.avatarUrl.isEmpty()}"
							 src="/img/demo/avatar2.jpg"
							 alt="默认头像"
							 class="rounded-circle"
							 style="width: 40px; height: 40px;">
					</th:block>

					<div class="ml-3 w-100">
						<div style="display: flex; justify-content: space-between; align-items: end; width: 100%;">
							<small class="font-weight-bold" style="flex-grow: 1; font-size: 16px">
								<a class="text-dark" th:if="${article.userName}" th:href="@{'/profile/' + ${article.userName}}" th:text="${article.userName}"></a>
								<span th:unless="${article.userName}" th:text="佚名"></span>
							</small>
							<div>
								<button type="button"
										th:id="${'followButton-' + article.userId}"
										th:class="${article.isFollowedByCurrentUser} ? 'btn btn-secondary btn-sm' : 'btn btn-outline-primary btn-sm'"
										th:onclick="'toggleFollow(\'' + ${article.userId} + '\', this)'">
									<span th:if="${article.isFollowedByCurrentUser}"><i class="fas fa-user-check"></i> 已关注</span>
									<span th:unless="${article.isFollowedByCurrentUser}"><i class="fas fa-user-plus"></i> 关注</span>
								</button>
							</div>
						</div>
						<small class="text-muted d-block">
							<th:block th:if="${article.gmtModified}" th:with="
								now = ${T(java.time.LocalDateTime).now()},
								duration = ${T(java.time.Duration).between(article.gmtModified, now)},
								days = ${duration.toDays()},
								totalHours = ${duration.toHours()},
								totalMinutes = ${duration.toMinutes()}">
								<span th:if="${days > 0}" th:text="${days + ' 天前'}"></span>
								<span th:if="${days == 0 and totalHours > 0}" th:text="${totalHours + ' 小时前'}"></span>
								<span th:if="${days == 0 and totalHours == 0 and totalMinutes > 0}" th:text="${totalMinutes + ' 分钟前'}"></span>
								<span th:if="${days == 0 and totalHours == 0 and totalMinutes == 0}" th:text="'刚刚'"></span>
							</th:block>
							<span th:unless="${article.gmtModified}">发布时间未知</span>
							&middot;
							<span style="display: inline-flex; align-items: center;">
							  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-bar-chart" viewBox="0 0 16 16" style="margin-right: 2px;">
								 <path d="M4 11H2v3h2v-3zm5-4H7v7h2V7zm5-5v12h-2V2h2zm-2-1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1h-2zM6 7a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm-5 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3z"/>
							  </svg>
							  <span th:text="${article.viewCount != null ? article.viewCount : '0'}" style="margin-right: 8px;">0</span>
							  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-suit-heart" viewBox="0 0 16 16" style="margin-right: 2px;">
								 <path d="m8 6.236-.894-1.789c-.222-.443-.607-1.08-1.152-1.595C5.418 2.345 4.776 2 4 2 2.324 2 1 3.326 1 4.92c0 1.211.554 2.066 1.868 3.37.337.334.721.695 1.146 1.093C5.122 10.423 6.5 11.717 8 13.447c1.5-1.73 2.878-3.024 3.986-4.064.425-.398.81-.76 1.146-1.093C14.446 6.986 15 6.131 15 4.92 15 3.326 13.676 2 12 2c-.777 0-1.418.345-1.954.852-.545.515-.93 1.152-1.152 1.595L8 6.236zm.392 8.292a.513.513 0 0 1-.784 0c-1.601-1.902-3.05-3.262-4.243-4.381C1.3 8.208 0 6.989 0 4.92 0 2.755 1.79 1 4 1c1.6 0 2.719 1.05 3.404 2.008.26.365.458.716.596.992a7.55 7.55 0 0 1 .596-.992C9.281 2.049 10.4 1 12 1c2.21 0 4 1.755 4 3.92 0 2.069-1.3 3.288-3.365 5.227-1.193 1.12-2.642 2.48-4.243 4.38z"/>
							  </svg>
							  <span th:text="${article.likes != null ? article.likes : '0'}">0</span>
						   </span>
						</small>
					</div>
				</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- 主要内容区域 -->
<div class="container-fluid pt-4 pb-4" style="max-width: 1600px;">
	<div class="row">
		<!-- 分享按钮侧边栏 -->
		<div class="col-lg-1 col-md-2 pr-3 mb-4" >
			<div class="sticky-top text-center" style="top: 80px;">
				<div class="text-muted mb-2">
					分享
				</div>
				<div class="share d-flex justify-content-center">
					<div class="d-flex flex-column align-items-center" style="width: 100%;">
						<a href="#" class="btn btn-outline-primary btn-sm mb-2 w-100" onclick="shareToWechat()">
							<i class="fab fa-weixin"></i>
						</a>
						<a href="#" class="btn btn-outline-info btn-sm mb-2 w-100" onclick="shareToWeibo()">
							<i class="fab fa-weibo"></i>
						</a>
						<a href="#" class="btn btn-outline-success btn-sm mb-2 w-100" onclick="copyLink()">
							<i class="fas fa-link"></i>
						</a>

						<div class="text-muted my-2 pt-2 border-top w-100"></div>
						<button th:class="${article.isLiked} ? 'btn btn-danger btn-sm mb-2 w-100' : 'btn btn-outline-danger btn-sm mb-2 w-100'"
								th:attr="data-article-id=${article.articleId}" onclick="toggleLike(event)" title="点赞">
							<i class="fas fa-heart"></i>
							<span id="likeCount" th:text="${article.likes ?: '0'}">0</span>
						</button>
						<button class="btn btn-outline-primary btn-sm mb-2 w-100" onclick="toggleFavorite()" title="收藏">
							<i class="fas fa-bookmark"></i>
						</button>
						<button class="btn btn-outline-info btn-sm mb-2 w-100" onclick="scrollToComments()" title="评论">
							<i class="fas fa-comments"></i>
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- 文章正文 -->
		<div class="col-lg-8 col-md-9">
			<article class="article-post">
				<!-- 文章内容 -->
				<div th:utext="${renderedHtmlContent}" class="article-content">
					<p>文章正文内容将在这里显示...</p>
				</div>
				<!-- 显示阅读量 -->
				<div class="mt-4 pt-4 border-top">
					<div class="d-flex justify-content-end align-items-center">
							<small class="text-muted">
								阅读量: <span th:text="${article.viewCount ?: '0'}">0</span>
							</small>
					</div>
				</div>

				<!-- 评论区 -->
					<div id="comments-section" class="mt-5">
						<h4 class="comments-title mb-4"><i class="fas fa-comments mr-2"></i>评论区</h4>
						<div class="comment-form-container mb-4 card" sec:authorize="isAuthenticated()">
							<div class="card-body">
								<form id="commentForm">
									<div class="form-group">
										<textarea class="form-control" id="commentContent" rows="3" placeholder="写下你的想法..."></textarea>
									</div>
									<div class="text-right">
										<button type="submit" class="btn btn-primary">发表评论</button>
									</div>
								</form>
							</div>
						</div>
						<div class="comment-form-container mb-4 card" sec:authorize="isAnonymous()">
							<div class="card-body text-center">
								<p class="mb-0">请<a th:href="@{/login}" class="font-weight-bold">登录</a>后发表评论</p>
							</div>
						</div>

						<div id="comments-list" class="comments-list">
							<div class="text-center py-5">
								<div class="spinner-border text-warning" role="status">
									<span class="sr-only">正在加载评论...</span>
								</div>
							</div>
						</div>
					</div>
			</article>
		</div>
	</div>
</div>

<!-- 相关文章推荐 -->
<div class="container-fluid pt-4 pb-4" style="max-width: 1600px;">
	<h5 class="font-weight-bold spanborder"><span>相关阅读</span></h5>
	<div class="row" th:if="${relatedArticles != null and !relatedArticles.isEmpty()}">
		<div class="col-lg-6" th:each="relatedArticle : ${relatedArticles}">
			<div class="card border-0 mb-4 box-shadow h-xl-300">

				<div class="card-body px-0 pb-0 d-flex flex-column align-items-start">
					<h2 class="h4 font-weight-bold">
						<a class="text-dark" th:href="@{'/article/' + ${relatedArticle.slug}}" th:text="${relatedArticle.title}">相关文章标题</a>
					</h2>
					<p class="card-text" th:text="${relatedArticle.excerpt}">
						相关文章摘要内容...
					</p>
					<div>
						<small class="d-block">
							<a class="text-muted" th:text="${relatedArticle.userName ?: '佚名'}">作者</a>
						</small>
						<small class="text-muted">
							<th:block th:if="${relatedArticle.gmtCreate}" th:with="
							 now = ${T(java.time.LocalDateTime).now()},
							 duration = ${T(java.time.Duration).between(relatedArticle.gmtCreate, now)},
							 days = ${duration.toDays()},
							 totalHours = ${duration.toHours()},
							 totalMinutes = ${duration.toMinutes()}">
								<span th:if="${days > 0}" th:text="${days + ' 天前'}"></span>
								<span th:if="${days == 0 and totalHours > 0}" th:text="${totalHours + ' 小时前'}"></span>
								<span th:if="${days == 0 and totalHours == 0 and totalMinutes > 0}" th:text="${totalMinutes + ' 分钟前'}"></span>
								<span th:if="${days == 0 and totalHours == 0 and totalMinutes == 0}" th:text="'刚刚'"></span>
							</th:block>
						</small>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 如果没有相关文章，显示默认推荐 -->
	<div class="row" th:if="${relatedArticles == null or relatedArticles.isEmpty()}">
		<div class="col-12">
			<p class="text-muted">暂无相关文章推荐</p>
			<a href="/" class="btn btn-primary">返回首页浏览更多文章</a>
		</div>
	</div>
</div>

<!-- 返回顶部按钮 -->
<button id="backToTop" class="btn btn-primary" style="display: none; position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
	<i class="fas fa-arrow-up"></i>
</button>

<!-- 替换原来的Toast消息组件 -->
<div id="customToast" style="display: none; position: fixed; bottom: 30px; right: 30px; background-color: white; box-shadow: 0 4px 8px rgba(0,0,0,0.2); border-radius: 4px; z-index: 9999; min-width: 300px; max-width: 400px;">
  <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; border-bottom: 1px solid #eee;">
    <div style="display: flex; align-items: center;">
      <i id="customToastIcon" class="fas fa-info-circle text-info mr-2"></i>
      <strong id="customToastTitle">提示</strong>
    </div>
    <button onclick="hideCustomToast()" style="background: none; border: none; cursor: pointer; font-size: 16px;">×</button>
  </div>
  <div id="customToastMessage" style="padding: 15px; font-size: 14px;">
    消息内容
  </div>
</div>

<!-- 页脚 -->
<div th:replace="~{fragments/footer :: page-footer}"></div>

<!-- JavaScript -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
<script th:src="@{/js/functions.js}" type="text/javascript"></script>
<script th:src="@{/js/article-effects.js}" type="text/javascript"></script>

<style>
/* 作品集样式 */
.portfolio-pill {
    display: inline-flex;
    align-items: center;
    padding: 6px 14px;
    background-color: #f0f7ff;
    border-radius: 30px;
    font-size: 0.9rem;
    color: #0366d6;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
    border: 1px solid #cce4ff;
}

.portfolio-pill:hover {
    background-color: #0366d6;
    color: white;
    text-decoration: none;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(3, 102, 214, 0.2);
}

/* 文章内容样式优化 */
.article-content {
    font-size: 1.05rem;
    line-height: 1.8;
    color: #333;
    max-width: 100%;
    margin: 0 auto;
}

.article-content p {
    margin-bottom: 1.5rem;
}

.article-content h1, .article-content h2, .article-content h3,
.article-content h4, .article-content h5, .article-content h6 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: 600;
    line-height: 1.4;
}

.article-content img {
    max-width: 100%;
    height: auto;
    margin: 1.5rem 0;
    border-radius: 4px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.article-content blockquote {
    border-left: 4px solid #007bff;
    padding-left: 1rem;
    margin-left: 0;
    color: #555;
    font-style: italic;
}

.article-content code {
    background-color: #f5f5f5;
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-family: SFMono-Regular, Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 0.9em;
}

.article-content pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 5px;
    overflow-x: auto;
    margin: 1.5rem 0;
    position: relative;
}

/* 评论区样式 */
.comments-title {
    font-weight: 600;
    color: #343a40;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
}

.comment-form-container {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 5px;
}

.comment-item {
    padding: 15px 0;
    border-bottom: 1px solid #e9ecef;
}

.comment-avatar, .reply-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
}

.reply-avatar {
    width: 30px;
    height: 30px;
}

.comment-meta, .reply-meta {
    flex-grow: 1;
}

.comment-author, .reply-author {
    font-weight: 600;
    font-size: 0.95rem;
}

.comment-date, .reply-date {
    font-size: 0.8rem;
    color: #6c757d;
}

.comment-content, .reply-content {
    margin: 10px 0;
    white-space: pre-wrap;
}

.comment-actions {
    display: flex;
    justify-content: flex-end;
}

.reply-btn {
    color: #6c757d;
    padding: 0;
}

.reply-btn:hover {
    color: #007bff;
    text-decoration: none;
}

.replies-container {
    margin-left: 30px;
    margin-top: 10px;
    padding-left: 15px;
    border-left: 2px solid #e9ecef;
}

.reply-item {
    padding: 10px 0;
}

.reply-form {
    margin-left: 30px;
    padding-left: 15px;
    border-left: 2px solid #e9ecef;
}

.no-comments {
    padding: 30px 0;
    color: #6c757d;
}

/* 响应式调整 */
@media (max-width: 768px) {
    .article-content {
        font-size: 1rem;
        line-height: 1.7;
    }
    
    .container {
        padding-left: 15px;
        padding-right: 15px;
    }
}

/* 优化链接样式 */
.article-content a {
    color: #007bff;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.2s ease;
}

.article-content a:hover {
    border-bottom-color: #007bff;
}

/* 优化表格样式 */
.article-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
}

.article-content table th,
.article-content table td {
    border: 1px solid #dee2e6;
    padding: 0.75rem;
}

.article-content table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

.article-content table tr:nth-child(even) {
    background-color: #f8f9fa;
}

/* Toast样式 */
.toast {
    background-color: rgba(255, 255, 255, 0.95);
    border-radius: 6px;
    box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(0, 0, 0, 0.1);
}

.toast-header {
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
}

.toast-body {
    padding: 12px;
    font-size: 0.95rem;
    line-height: 1.5;
}
</style>

</body>
</html>