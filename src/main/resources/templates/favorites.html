<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:insert="~{fragments/page-head :: common-head-content}"></th:block>

  <title>我的收藏 - Lumi Hive</title>

  <link rel="stylesheet" th:href="@{/css/tags.css}"/>
</head>
<body>

<div th:replace="~{fragments/header :: navbar}"></div>

<div class="main-container">
  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">我的收藏</h1>
      <p class="hero-subtitle">珍藏您喜爱的文章、作品集和创意灵感</p>
    </div>
  </section>

  <!-- Content Container -->
  <div class="content-container">
    <div class="container">
      <!-- Filter Section -->
      <div class="filter-section fade-in">
        <div class="search-container">
          <div class="search-icon">
            <i class="fas fa-search"></i>
          </div>
          <input type="search" id="favoriteSearchInput" class="search-input" placeholder="搜索我的收藏...">
        </div>

        <div id="favoriteListContainer" class="tag-container">
          <a class="tag-item active"
             data-type="all"
             onclick="handleTypeClick(this)">
            <i class="fas fa-layer-group"></i> 全部收藏
          </a>
          <a class="tag-item"
             data-type="article"
             onclick="handleTypeClick(this)">
            <i class="fas fa-file-alt"></i> 文章
          </a>
          <a class="tag-item"
             data-type="portfolio"
             onclick="handleTypeClick(this)">
            <i class="fas fa-book-open"></i> 作品集
          </a>
          <a class="tag-item"
             data-type="tag"
             onclick="handleTypeClick(this)">
            <i class="fas fa-tag"></i> 标签
          </a>
        </div>
      </div>

      <!-- Favorites Section -->
      <section class="articles-section">
        <h2 class="section-title">
          收藏列表
          <small id="favoriteListTitle" class="section-subtitle">(全部收藏)</small>
        </h2>

        <div id="article-display-container">
          <div id="loadingSpinner" class="loading-spinner"></div>
          <div id="articleGrid" class="article-grid stagger-children">
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<div th:replace="~{fragments/footer :: page-footer}"></div>

<!-- Favorite Card Template -->
<template id="articleCardTemplate">
  <a href="#" class="article-card">
    <div class="card-content">
      <div class="author-section">
        <img src="/img/default01.jpg" alt="作者头像" class="author-avatar">
        <div class="author-info">
          <p class="author-name">作者</p>
          <p class="publish-date"></p>
        </div>
      </div>
      <div class="favorite-type-badge">文章</div>
      <h3 class="article-title">收藏标题</h3>
      <p class="article-excerpt">收藏描述...</p>
    </div>
  </a>
</template>

<script th:src="@{/js/vendor/jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/js/vendor/popper.min.js}" type="text/javascript"></script>
<script th:src="@{/js/vendor/bootstrap.min.js}" type="text/javascript"></script>
<script th:src="@{/js/functions.js}" type="text/javascript"></script>

<script>
  // 全局变量
  let activeType = 'all';

  // DOM加载完成后执行
  document.addEventListener('DOMContentLoaded', function() {
    const favoriteSearchInput = document.getElementById('favoriteSearchInput');

    // 添加搜索功能
    favoriteSearchInput.addEventListener('input', handleFavoriteSearch);

    // 初始加载所有收藏
    fetchAndRenderFavorites(activeType);

    // 添加页面加载动画
    setTimeout(() => {
      document.querySelector('.filter-section').classList.add('fade-in');
    }, 300);
  });

  // 处理类型点击
  function handleTypeClick(element) {
    // 移除所有激活状态
    document.querySelectorAll('.tag-item').forEach(tag => {
      tag.classList.remove('active');
    });

    // 激活当前类型
    element.classList.add('active');

    // 更新活跃类型和标题
    activeType = element.getAttribute('data-type');
    let typeName;
    switch(activeType) {
      case 'article':
        typeName = '文章收藏';
        break;
      case 'portfolio':
        typeName = '作品集收藏';
        break;
      case 'tag':
        typeName = '标签收藏';
        break;
      default:
        typeName = '全部收藏';
    }
    
    document.getElementById('favoriteListTitle').textContent = `(${typeName})`;
    
    // 获取收藏
    fetchAndRenderFavorites(activeType);
  }

  // 处理收藏搜索
  function handleFavoriteSearch(event) {
    const filterValue = event.target.value.toLowerCase();
    const favoriteCards = document.querySelectorAll('#articleGrid .article-card');

    favoriteCards.forEach(card => {
      const title = card.querySelector('.article-title').textContent.toLowerCase();
      const excerpt = card.querySelector('.article-excerpt').textContent.toLowerCase();
      
      if (title.includes(filterValue) || excerpt.includes(filterValue)) {
        card.style.display = '';
      } else {
        card.style.display = 'none';
      }
    });
  }

  // 获取并渲染收藏
  async function fetchAndRenderFavorites(type) {
    const articleGrid = document.getElementById('articleGrid');
    const spinner = document.getElementById('loadingSpinner');

    // 显示加载动画
    spinner.style.display = 'block';
    articleGrid.innerHTML = '';
    articleGrid.classList.remove('stagger-children');

    const apiUrl = `/api/favorites/${type}`;

    try {
      const response = await fetch(apiUrl);
      if (!response.ok) throw new Error('网络响应错误');

      const favorites = await response.json();

      if (favorites.length === 0) {
        articleGrid.innerHTML = `
          <div class="no-articles">
            <div class="no-articles-icon"><i class="fas fa-bookmark"></i></div>
            <h3>暂无收藏</h3>
            <p>您还没有添加任何收藏，浏览内容时点击收藏按钮即可添加</p>
          </div>
        `;
      } else {
        // 添加交错动画类
        articleGrid.classList.add('stagger-children');

        favorites.forEach((favorite) => {
          const card = createFavoriteCard(favorite);
          articleGrid.appendChild(card);
        });
      }
    } catch (error) {
      console.error('获取收藏失败:', error);
      articleGrid.innerHTML = `
        <div class="error-message">
          <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
          <h3>加载失败</h3>
          <p>无法加载收藏列表，请检查网络连接后重试</p>
          <button onclick="fetchAndRenderFavorites(activeType)" class="retry-button">
            <i class="fas fa-sync-alt"></i> 重试
          </button>
        </div>
      `;
    } finally {
      spinner.style.display = 'none';
    }
  }

  // 创建收藏卡片
  function createFavoriteCard(favorite) {
    const template = document.getElementById('articleCardTemplate');
    const cardClone = template.content.cloneNode(true);

    const link = cardClone.querySelector('.article-card');
    const title = cardClone.querySelector('.article-title');
    const excerpt = cardClone.querySelector('.article-excerpt');
    const authorName = cardClone.querySelector('.author-name');
    const authorAvatar = cardClone.querySelector('.author-avatar');
    const publishDate = cardClone.querySelector('.publish-date');
    const typeBadge = cardClone.querySelector('.favorite-type-badge');

    // 设置链接和内容
    link.href = favorite.url;
    title.textContent = favorite.title;
    excerpt.textContent = favorite.description || '暂无描述...';
    
    // 设置作者信息
    if (favorite.author) {
      authorName.textContent = favorite.author.name || '佚名';
      authorAvatar.src = favorite.author.avatarUrl || '/img/default01.jpg';
    }

    // 设置收藏类型
    switch(favorite.type) {
      case 'article':
        typeBadge.textContent = '文章';
        typeBadge.className = 'favorite-type-badge article-badge';
        break;
      case 'portfolio':
        typeBadge.textContent = '作品集';
        typeBadge.className = 'favorite-type-badge portfolio-badge';
        break;
      case 'tag':
        typeBadge.textContent = '标签';
        typeBadge.className = 'favorite-type-badge tag-badge';
        break;
      default:
        typeBadge.textContent = '其他';
        typeBadge.className = 'favorite-type-badge';
    }

    // 格式化收藏日期
    if (favorite.favoriteDate) {
      const date = new Date(favorite.favoriteDate);
      const formattedDate = `收藏于 ${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      publishDate.textContent = formattedDate;
    }

    return cardClone;
  }
</script>

<style>
  /* 收藏页面特定样式 */
  .favorite-type-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 8px;
    background-color: #e9ecef;
    color: #495057;
  }
  
  .article-badge {
    background-color: rgba(52, 152, 219, 0.15);
    color: #3498db;
  }
  
  .portfolio-badge {
    background-color: rgba(46, 204, 113, 0.15);
    color: #2ecc71;
  }
  
  .tag-badge {
    background-color: rgba(155, 89, 182, 0.15);
    color: #9b59b6;
  }
</style>

</body>
</html> 