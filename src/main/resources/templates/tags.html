<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
  <th:block th:insert="~{fragments/page-head :: common-head-content}"></th:block>

  <title>探索标签 - Lumi Hive</title>

  <link rel="stylesheet" th:href="@{/css/tags.css}"/>
</head>
<body>

<div th:replace="~{fragments/header :: navbar}"></div>

<div class="main-container">
  <!-- Hero Section -->
  <section class="hero-section">
    <div class="hero-content">
      <h1 class="hero-title">探索标签</h1>
      <p class="hero-subtitle">发现感兴趣的内容，探索知识的边界</p>
    </div>
  </section>

  <!-- Content Container -->
  <div class="content-container">
    <div class="container">
      <!-- Filter Section -->
      <div class="filter-section fade-in">
        <div class="search-container">
          <div class="search-icon">
            <i class="fas fa-search"></i>
          </div>
          <input type="search" id="tagSearchInput" class="search-input" placeholder="输入关键词快速找到标签...">
        </div>

        <div id="tagListContainer" class="tag-container">
          <a class="tag-item active"
             data-slug="all"
             onclick="handleTagClick(this)">
            <i class="fas fa-layer-group"></i> 所有文章
          </a>
          <a th:each="tag : ${allTags}"
             class="tag-item"
             th:attr="data-slug=${tag.slug}"
             onclick="handleTagClick(this)">
            <i class="fas fa-tag"></i> <span th:text="${tag.name}"></span>
          </a>
        </div>
      </div>

      <!-- Articles Section -->
      <section class="articles-section">
        <h2 class="section-title">
          文章列表
          <small id="articleListTitle" class="section-subtitle">(所有文章)</small>
        </h2>

        <div id="article-display-container">
          <div id="loadingSpinner" class="loading-spinner"></div>
          <div id="articleGrid" class="article-grid stagger-children">
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<div th:replace="~{fragments/footer :: page-footer}"></div>

<!-- Article Card Template -->
<template id="articleCardTemplate">
  <a href="#" class="article-card">
    <div class="card-content">
      <div class="author-section">
        <img src="/img/default01.jpg" alt="作者头像" class="author-avatar">
        <div class="author-info">
          <p class="author-name">作者</p>
          <p class="publish-date"></p>
        </div>
      </div>
      <h3 class="article-title">文章标题</h3>
      <p class="article-excerpt">文章摘要...</p>
    </div>
  </a>
</template>

<script th:src="@{/js/vendor/jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/js/vendor/popper.min.js}" type="text/javascript"></script>
<script th:src="@{/js/vendor/bootstrap.min.js}" type="text/javascript"></script>
<script th:src="@{/js/functions.js}" type="text/javascript"></script>

<script>
  // 全局变量
  let activeSlug = 'all';

  // DOM加载完成后执行
  document.addEventListener('DOMContentLoaded', function() {
    const tagSearchInput = document.getElementById('tagSearchInput');

    // 添加搜索功能
    tagSearchInput.addEventListener('input', handleTagSearch);

    // 初始加载文章
    fetchAndRenderArticles(activeSlug);

    // 添加页面加载动画
    setTimeout(() => {
      document.querySelector('.filter-section').classList.add('fade-in');
    }, 300);
  });

  // 处理标签点击
  function handleTagClick(element) {
    // 移除所有激活状态
    document.querySelectorAll('.tag-item').forEach(tag => {
      tag.classList.remove('active');
    });

    // 激活当前标签
    element.classList.add('active');

    // 更新活跃slug和标题
    activeSlug = element.getAttribute('data-slug');
    const tagName = activeSlug === 'all' ? '所有文章' : element.textContent.trim();
    document.getElementById('articleListTitle').textContent = `(${tagName})`;

    // 获取文章
    fetchAndRenderArticles(activeSlug);
  }

  // 处理标签搜索
  function handleTagSearch(event) {
    const filterValue = event.target.value.toLowerCase();
    const tags = document.querySelectorAll('#tagListContainer .tag-item');

    tags.forEach(tag => {
      if (tag.getAttribute('data-slug') === 'all') return;

      const tagName = tag.textContent.toLowerCase();
      if (tagName.includes(filterValue)) {
        tag.style.display = '';
        tag.style.animation = 'fadeIn 0.3s ease-out';
      } else {
        tag.style.display = 'none';
      }
    });
  }

  // 获取并渲染文章
  async function fetchAndRenderArticles(slug) {
    const articleGrid = document.getElementById('articleGrid');
    const spinner = document.getElementById('loadingSpinner');

    // 显示加载动画
    spinner.style.display = 'block';
    articleGrid.innerHTML = '';
    articleGrid.classList.remove('stagger-children');

    const apiUrl = `/api/tags/${slug}`;

    try {
      const response = await fetch(apiUrl);
      if (!response.ok) throw new Error('网络响应错误');

      const articles = await response.json();

      if (articles.length === 0) {
        articleGrid.innerHTML = `
          <div class="no-articles">
            <div class="no-articles-icon"><i class="fas fa-file-alt"></i></div>
            <h3>暂无文章</h3>
            <p>该标签下还没有文章，期待更多精彩内容...</p>
          </div>
        `;
      } else {
        // 添加交错动画类
        articleGrid.classList.add('stagger-children');

        articles.forEach((article, index) => {
          const card = createArticleCard(article);
          articleGrid.appendChild(card);
        });
      }
    } catch (error) {
      console.error('获取文章失败:', error);
      articleGrid.innerHTML = `
        <div class="error-message">
          <div class="error-icon"><i class="fas fa-exclamation-triangle"></i></div>
          <h3>加载失败</h3>
          <p>无法加载文章列表，请检查网络连接后重试</p>
          <button onclick="fetchAndRenderArticles(activeSlug)" class="retry-button">
            <i class="fas fa-sync-alt"></i> 重试
          </button>
        </div>
      `;
    } finally {
      spinner.style.display = 'none';
    }
  }

  // 创建文章卡片
  function createArticleCard(article) {
    const template = document.getElementById('articleCardTemplate');
    const cardClone = template.content.cloneNode(true);

    const link = cardClone.querySelector('.article-card');
    const title = cardClone.querySelector('.article-title');
    const excerpt = cardClone.querySelector('.article-excerpt');
    const authorName = cardClone.querySelector('.author-name');
    const authorAvatar = cardClone.querySelector('.author-avatar');
    const publishDate = cardClone.querySelector('.publish-date');

    // 设置链接和内容
    link.href = `/article/${article.slug}`;
    title.textContent = article.title;
    excerpt.textContent = article.excerpt || '暂无摘要...';
    authorName.textContent = article.userName || '佚名';
    authorAvatar.src = article.avatarUrl || '/img/default01.jpg';

    // 格式化日期
    if (article.gmtCreate) {
      const date = new Date(article.gmtCreate);
      const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      publishDate.textContent = formattedDate;
    }

    return cardClone;
  }
</script>

</body>
</html>